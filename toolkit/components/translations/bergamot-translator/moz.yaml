# Version of this schema
schema: 1

bugzilla:
  # Bugzilla product and component for this directory and subdirectories
  product: Firefox
  component: Translation

# Document the source of externally hosted code
origin:

  # Short name of the package/library
  name: bergamot-translator

  description: The JavaScript emscripten worker to run Project Bergamot.

  # Full URL for the package's homepage/etc
  # Usually different from repository url
  url: https://github.com/mozilla/bergamot-translator/

  # Human-readable identifier for this version/release
  # Generally "version NNN", "tag SSS", "bookmark SSS"
  release: v0.4.4

  # Revision to pull in
  # Must be a long or short commit SHA (long preferred)
  revision: 5ae1b1ebb3fa9a3eabed8a64ca6798154bd486eb

  # The package's license, where possible using the mnemonic from
  # https://spdx.org/licenses/
  # Multiple licenses can be specified (as a YAML list)
  # A "LICENSE" file must exist containing the full license text
  license: MPL-2.0

  notes: >
    The generated emscripten code contains many global variables. When updating
    the code, paste it into the following function to protect the global scope.

    ```
    /* This Source Code Form is subject to the terms of the Mozilla Public
     * License, v. 2.0. If a copy of the MPL was not distributed with this
     * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

    function loadBergamot(Module) {
      {insertCodeHere}
      return Module;
    }
    ```

    Then replace `console.log()` calls with `log()` calls so that logging preferences
    are respected.

    Finally add some instrumentation to the wasm module allocations.

    ```
    diff --git a/toolkit/components/translations/bergamot-translator/bergamot-translator.js b/toolkit/components/translations/bergamot-translator/bergamot-translator.js
    index 6667121a4726f..c5327872ca7ba 100644
    --- a/toolkit/components/translations/bergamot-translator/bergamot-translator.js
    +++ b/toolkit/components/translations/bergamot-translator/bergamot-translator.js
    @@ -341,7 +341,13 @@ function loadBergamot(Module) {

      var buffer, HEAP8, HEAPU8, HEAP16, HEAPU16, HEAP32, HEAPU32, HEAPF32, HEAPF64;

    +  function getBufferSize(buf) {
    +    const mb = buf.byteLength / 1000_0000;
    +    return `${Math.floor(mb * 100) / 100}MB`;
    +  }
    +
      function updateGlobalBufferAndViews(buf) {
    +    log(`Growing wasm buffer to ${getBufferSize(buf)}.`);
        buffer = buf;
        Module["HEAP8"] = HEAP8 = new Int8Array(buf);
        Module["HEAP16"] = HEAP16 = new Int16Array(buf);
    @@ -367,6 +373,7 @@ function loadBergamot(Module) {
      if (wasmMemory) {
        buffer = wasmMemory.buffer;
      }
    +  log(`The initial wasm buffer size is: ${getBufferSize(buffer)}.`);

      INITIAL_MEMORY = buffer.byteLength;
    ```
